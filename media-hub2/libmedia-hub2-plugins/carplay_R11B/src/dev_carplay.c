/*
 * Generated by object-codegen.
 */
#include <glib.h>
#include <stdio.h>
#include "dev_carplay.h"
#include <mh_core.h>
#include <mh_player.h>
#include <string.h>
#include <gst/gst.h>

#include <AirPlayUtils.h>
#include <HIDUtils.h>

typedef struct _MHDevCarplayPrivate MHDevCarplayPrivate;

struct _MHDevCarplayPrivate
{
	gint dummy;
};

G_DEFINE_TYPE_WITH_PRIVATE( MHDevCarplay, mh_dev_carplay, MH_TYPE_DEV )

enum {
	/* Ios */

	/* Signals */
	DUCK_AUDIO,
	UNDUCK_AUDIO,
	DISALBE_BLUETOOTH,
	MODES_CHANGED,
	HID_SET_INPUT_MODE,
	REQUEST_UI,

	N_SIGNALS
};

static guint signals[ N_SIGNALS ] = {0};

enum
{
	PROP_0,

	PROP_DEV_CARPLAY_CHANGEMODES,
	PROP_DEV_CARPLAY_KEYFRAME,
	PROP_DEV_CARPLAY_REQUEST_SIRI_ACTION,
	PROP_DEV_CARPLAY_REQUEST_UI,
	PROP_DEV_CARPLAY_NIGHTMODE,
	PROP_DEV_CARPLAY_SETLIMITUI,
	PROP_DEV_CARPLAY_VIDEO_SINK,
	PROP_DEV_CARPLAY_SIGNAL_TOUCH,

	N_PROPERTIES
};

static GParamSpec *devCarplayProperties[ N_PROPERTIES ] = { NULL, };

/*
 * ===  FUNCTION  ======================================================================
 *         Name:  _get_property
 *  Description:
 * =====================================================================================
 */
static void _get_property( GObject * object, guint property_id, GValue * value,
		        GParamSpec * spec)
{
	MHDevCarplay * _self  =   MH_DEV_CARPLAY( object );
	void * _videoSink;

	switch( property_id )
	{
	case PROP_DEV_CARPLAY_VIDEO_SINK:
		if( _self->videoPipeline != NULL )
			g_object_get( _self->videoPipeline, "video-sink", &_videoSink, NULL );

		if( _videoSink != NULL )
		{
			g_value_set_uint( value, ( guint )_videoSink );
		}
		break;
	default:
		break;
	}
}       /*  -----  end of static function _get_property  ----- */

/* 
 * ===  FUNCTION  ======================================================================
 *         Name:  post_hid_report
 *  Description:  
 * =====================================================================================
 */
static void post_hid_report( const char * report )
{
	/* Report format: x,xxx,xxx */
	static uint8_t _report[5]	=	{ 0 };

	_report[0]	=	report[0] == '0' ? 0 : 1;
	if( _report[0] == 1 )
	{
		int _x, _y;

		_x	=	atoi( report + 2 );
		_y	=	atoi( report + 6 );

		_report[ 1 ]	=	(uint8_t)(   _x        & 0xFF );
		_report[ 2 ]	=	(uint8_t)( ( _x >> 8 ) & 0xFF );
		_report[ 3 ]	=	(uint8_t)(   _y        & 0xFF );
		_report[ 4 ]	=	(uint8_t)( ( _y >> 8 ) & 0xFF );
	}

	HIDPostReport( CFSTR( "e5f7a68d-7b0f-4305-984b-974f677a150b" ),
			_report, sizeof( _report ));
}		/* -----  end of static function post_hid_report  ----- */
/*
 * ===  FUNCTION  ======================================================================
 *         Name:  _set_property
 *  Description:
 * =====================================================================================
 */
static void _set_property( GObject * object, guint property_id, const GValue * value,
		        GParamSpec * spec)
{
	MHDevCarplay * _self  =   MH_DEV_CARPLAY( object );
	AirPlayModeChanges _changes;
	const gchar * _value;

	switch( property_id )
	{
	case PROP_DEV_CARPLAY_CHANGEMODES:
		_value	=	g_value_get_string( value );

		if( strncmp( _value, "screen", 6 ) == 0 )
		{
			if( strncmp( _value + 7, "take", 4 ) == 0 )
			{
				AirPlayReceiverSessionTakeScreen( _self->inSession, kAirPlayTransferPriority_UserInitiated,
						kAirPlayConstraint_UserInitiated, kAirPlayConstraint_UserInitiated, NULL, NULL, _self->inContext );
			}
			else
			if( strncmp( _value + 7, "untake", 6 ) == 0 )
			{
				AirPlayReceiverSessionUntakeScreen( _self->inSession, NULL, NULL, _self->inContext );
			}
			else
			if( strncmp( _value + 7, "borrow", 6 ) == 0 )
			{
				AirPlayReceiverSessionBorrowScreen( _self->inSession, kAirPlayTransferPriority_UserInitiated,
						kAirPlayConstraint_UserInitiated, NULL, NULL, _self->inContext );
			}
			else
			if( strncmp( _value + 7, "unborrow", 8 ) == 0 )
			{
				AirPlayReceiverSessionUnborrowScreen( _self->inSession, NULL, NULL, _self->inContext );
			}
			else
			{
				g_warning( "Unknown change modes command: %s", _value );
			}
		}
		else
		if( strncmp( _value, "main_audio", 10 ) == 0 )
		{
			if( strncmp( _value + 11, "take", 4 ) == 0 )
			{
				AirPlayReceiverSessionTakeMainAudio( _self->inSession, kAirPlayTransferPriority_UserInitiated,
						kAirPlayConstraint_UserInitiated, kAirPlayConstraint_UserInitiated, NULL, NULL, _self->inContext );
			}
			else
			if( strncmp( _value + 11, "untake", 6 ) == 0 )
			{
				AirPlayReceiverSessionUntakeMainAudio( _self->inSession, NULL, NULL, _self->inContext );
			}
			else
			if( strncmp( _value + 11, "borrow", 6 ) == 0 )
			{
				AirPlayReceiverSessionBorrowMainAudio( _self->inSession, kAirPlayTransferPriority_UserInitiated,
						kAirPlayConstraint_UserInitiated, NULL, NULL, _self->inContext );
			}
			else
			if( strncmp( _value + 11, "unborrow", 8 ) == 0 )
			{
				AirPlayReceiverSessionUnborrowMainAudio( _self->inSession, NULL, NULL, _self->inContext );
			}
			else
			{
				g_warning( "Unknown change modes command: %s", _value );
			}
		}
		else
		{
			g_warning( "Unknown change modes command: %s", _value );
		}

		break;
	case PROP_DEV_CARPLAY_KEYFRAME:
		AirPlayReceiverSessionForceKeyFrame( _self->inSession, NULL, _self->inContext );
		break;
	case PROP_DEV_CARPLAY_REQUEST_SIRI_ACTION:
		AirPlayReceiverSessionRequestSiriAction( _self->inSession, g_value_get_int( value ), NULL, 
				_self->inContext );
		break;
	case PROP_DEV_CARPLAY_REQUEST_UI:
		AirPlayReceiverSessionRequestUI( _self->inSession, 
				CFStringCreateWithCString( NULL, g_value_get_string( value ), kCFStringEncodingUTF8),
				NULL, _self->inContext );
		break;
	case PROP_DEV_CARPLAY_NIGHTMODE:
		AirPlayReceiverSessionSetNightMode( _self->inSession, g_value_get_boolean( value ), NULL,
				_self->inContext );
		break;
	case PROP_DEV_CARPLAY_SETLIMITUI:
		AirPlayReceiverSessionSetLimitedUI( _self->inSession, g_value_get_boolean( value ), NULL,
				_self->inContext );
		break;
	case PROP_DEV_CARPLAY_SIGNAL_TOUCH:
		_value	=	g_value_get_string( value );

		post_hid_report( _value );

		break;
	default:
		break;
	}
}       /*  -----  end of static function _set_property  ----- */
/*
 * ===  FUNCTION  ======================================================================
 *         Name:  _dispose
 *  Description:
 * =====================================================================================
 */
static void _dispose( GObject * object )
{
	MHDevCarplay * _self	=	MH_DEV_CARPLAY( object );

	gst_element_set_state( (GstElement *)_self->videoPipeline, GST_STATE_READY);

	AirPlayReceiverSessionPlatformFinalize( _self->inSession );
//	AirPlayReceiverSessionTearDown( _self->inSession, NULL, kNoErr, NULL );

	G_OBJECT_CLASS( mh_dev_carplay_parent_class )->dispose( object );
}

/*
 * ===  FUNCTION  ======================================================================
 *         Name:  _finalize
 *  Description:
 * =====================================================================================
 */
static void _finalize( GObject * object )
{
	MHDevCarplay * _self	=	MH_DEV_CARPLAY( object );
	MHDevCarplayPrivate * _priv	=	mh_dev_carplay_get_instance_private( _self );
}

/*
 * ===  FUNCTION  ======================================================================
 *         Name:  mh_dev_carplay_init
 *  Description:
 * =====================================================================================
 */
static void mh_dev_carplay_init( MHDevCarplay * self )
{
	MHDevCarplayPrivate * _priv	=	mh_dev_carplay_get_instance_private( self );
	MHDev * _dev	=	MH_DEV( self );
	AirPlayModeChanges _modes;

	_dev->type	=	"carplay";
	_dev->serial	=	"virtual_carplay_device";

	AirPlayModeChangesInit( &_modes );

	_modes.screen.takeConstraint	=	kAirPlayConstraint_UserInitiated;
	_modes.screen.borrowOrUnborrowConstraint	=	kAirPlayConstraint_UserInitiated;
	
	_modes.mainAudio.takeConstraint	=	kAirPlayConstraint_UserInitiated;
	_modes.mainAudio.borrowOrUnborrowConstraint	=	kAirPlayConstraint_UserInitiated;

	_modes.phoneCall	=	kAirPlayTriState_False;
	_modes.speech	=	kAirPlaySpeechMode_None;
	_modes.turnByTurn	=	kAirPlayTriState_False;

	self->modes	=	AirPlayCreateModesDictionary( &_modes, NULL, NULL );
}       /* -----  end of static function mh_dev_carplay_init  ----- */

/*
 * ===  FUNCTION  ======================================================================
 *         Name:  mh_dev_carplay_class_init
 *  Description:
 * =====================================================================================
 */
static void mh_dev_carplay_class_init( MHDevCarplayClass * klass )
{
	MHDevClass * _parentClass	=	MH_DEV_CLASS( klass );
	GObjectClass * _gobjectClass	=	G_OBJECT_CLASS( klass );

	_gobjectClass->dispose	=	_dispose;
	_gobjectClass->finalize	=	_finalize;
	_gobjectClass->set_property =   _set_property;
	_gobjectClass->get_property =   _get_property;

	/* assemble ios of mh_dev_carplay class */

	/* assemble methods of mh_dev_carplay class */

	/* Properties of mh_dev_carplay class */

	devCarplayProperties[ PROP_DEV_CARPLAY_CHANGEMODES ]	=	
		g_param_spec_string( "change_modes", "MHDevCarplay's property", "Change CarPlay modes request",
				"", G_PARAM_WRITABLE );

	devCarplayProperties[ PROP_DEV_CARPLAY_KEYFRAME ]	=	
		g_param_spec_boolean( "keyframe", "MHDevCarplay's property", "Force a key frame to be sent for the screen stream",
				FALSE, G_PARAM_READWRITE );

	devCarplayProperties[ PROP_DEV_CARPLAY_REQUEST_SIRI_ACTION ]	=	
		g_param_spec_int( "request_siri_action", "MHDevCarplay's property", "Requests that Siri be invoked with a specified action",
				0, 3, 0, G_PARAM_WRITABLE );

	devCarplayProperties[ PROP_DEV_CARPLAY_REQUEST_UI ]	=	
		g_param_spec_string( "request_ui", "MHDevCarplay's property", "Ask for the	CarPlay UI to be shown",
				"", G_PARAM_WRITABLE );

	devCarplayProperties[ PROP_DEV_CARPLAY_NIGHTMODE ]	=	
		g_param_spec_boolean( "night_mode", "MHDevCarplay's property", "Indicate whether it is dark outside",
				FALSE, G_PARAM_WRITABLE );

	devCarplayProperties[ PROP_DEV_CARPLAY_SETLIMITUI ]	=	
		g_param_spec_boolean( "set_limit_ui", "MHDevCarplay's property", "Indicate whether or not to limit certain UI elements",
				FALSE, G_PARAM_WRITABLE );

	devCarplayProperties[ PROP_DEV_CARPLAY_VIDEO_SINK ]	=	
		g_param_spec_uint( "video_sink", "MHDevCarplay's property", "Video sink of CarPlay video output",
				0, G_MAXUINT, 0, G_PARAM_READABLE );
	
	devCarplayProperties[ PROP_DEV_CARPLAY_SIGNAL_TOUCH ]	=	
		g_param_spec_string( "signal_touch", "MHDevCarplay's property", "Signal touch data",
				"", G_PARAM_WRITABLE );

	g_object_class_install_properties( _gobjectClass, N_PROPERTIES, devCarplayProperties );

	/* Ios */

	/* Signals */
	signals[ DUCK_AUDIO ]	=	
		g_signal_new( "duck_audio",
				G_TYPE_FROM_CLASS( klass ),
				G_SIGNAL_RUN_LAST,
				0,
				NULL,
				NULL,
				g_cclosure_marshal_generic,
				G_TYPE_NONE,
				2,
				G_TYPE_INT, G_TYPE_INT );       /* durationMS, volume */

	signals[ UNDUCK_AUDIO ]	=	
		g_signal_new( "unduck_audio",
				G_TYPE_FROM_CLASS( klass ),
				G_SIGNAL_RUN_LAST,
				0,
				NULL,
				NULL,
				g_cclosure_marshal_generic,
				G_TYPE_NONE,
				1,
				G_TYPE_INT );       /* durationMS */

	signals[ DISALBE_BLUETOOTH ]	=	
		g_signal_new( "disable_bluetooth",
				G_TYPE_FROM_CLASS( klass ),
				G_SIGNAL_RUN_LAST,
				0,
				NULL,
				NULL,
				g_cclosure_marshal_generic,
				G_TYPE_NONE,
				1,
				G_TYPE_STRING );       /* devicdID */

	signals[ MODES_CHANGED ]	=	
		g_signal_new( "modes_changed",
				G_TYPE_FROM_CLASS( klass ),
				G_SIGNAL_RUN_LAST,
				0,
				NULL,
				NULL,
				g_cclosure_marshal_generic,
				G_TYPE_NONE,
				6,
				G_TYPE_STRING, G_TYPE_STRING, G_TYPE_STRING, 
				G_TYPE_STRING, G_TYPE_STRING, G_TYPE_STRING );

	signals[ HID_SET_INPUT_MODE ]	=	
		g_signal_new( "hid_set_input_mode",
				G_TYPE_FROM_CLASS( klass ),
				G_SIGNAL_RUN_LAST,
				0,
				NULL,
				NULL,
				g_cclosure_marshal_generic,
				G_TYPE_NONE,
				2,
				G_TYPE_INT, G_TYPE_STRING );    /* hidInputMode, uuid */

	signals[ REQUEST_UI ]	=	
		g_signal_new( "request_ui",
				G_TYPE_FROM_CLASS( klass ),
				G_SIGNAL_RUN_LAST,
				0,
				NULL,
				NULL,
				g_cclosure_marshal_generic,
				G_TYPE_NONE,
				0 );                /* URL */
}       /* -----  end of static function mh_dev_carplay_class_init  ----- */

